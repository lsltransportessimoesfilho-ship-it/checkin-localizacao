<div id="status"></div>
<div id="formulario" style="display:none; height: 90vh;">
  <iframe 
    src="" 
    id="iframeForm" 
    style="width: 100%; height: 100%; border: none;">
  </iframe>
</div>

<script>
  const LATITUDE_ALVO = -12.6316685;  
  const LONGITUDE_ALVO = -38.265392; 
  const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSc9tq-rajX4bXekfQcl8p01VraF5lRMPg0uJAnVBIx_KTzW5w/viewform?embedded=true";
  const RAIO_MAX_METROS = 150;

  function iniciarRegistro() {
    document.getElementById('status').innerText = "Solicitando permissão de localização...";
    
    if (!navigator.geolocation) {
      document.getElementById('status').innerText = "Geolocalização não é suportada neste navegador.";
      return;
    }

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        const distancia = calcularDistancia(lat, lon, LATITUDE_ALVO, LONGITUDE_ALVO);

        document.getElementById('status').innerHTML = `
          Sua localização atual:<br>
          Latitude: ${lat.toFixed(6)}<br>
          Longitude: ${lon.toFixed(6)}<br>
          Distância até o ponto-alvo: ${distancia.toFixed(1)}m
        `;

        if (distancia <= RAIO_MAX_METROS) {
          setTimeout(() => {
            document.getElementById('status').innerText = "Dentro do perímetro. Carregando formulário...";
            document.getElementById('iframeForm').src = FORM_URL;
            document.getElementById('formulario').style.display = "block";
          }, 1500);
        }
      },
      (err) => {
        if (err.code === 1) {
          document.getElementById('status').innerText = "Permissão negada. Clique no botão para tentar novamente.";
        } else {
          document.getElementById('status').innerText = "Erro ao obter localização.";
        }
      }
    );
  }

  function calcularDistancia(lat1, lon1, lat2, lon2) {
    const R = 6371000; // metros
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a =
      Math.sin(dLat / 2) ** 2 +
      Math.cos(lat1 * Math.PI / 180) *
      Math.cos(lat2 * Math.PI / 180) *
      Math.sin(dLon / 2) ** 2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }
</script>
