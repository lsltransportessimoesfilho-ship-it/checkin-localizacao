<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registro de Chegada ‚Ä¢ LSL Transportes</title>
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #004aad, #0077ff);
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .card {
      background: #ffffff;
      color: #111827;
      max-width: 400px;
      width: 100%;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 6px 20px rgba(0,0,0,.15);
      text-align: center;
    }
    h1 {
      font-size: 1.5rem;
      margin-bottom: 4px;
    }
    h2 {
      font-size: 1rem;
      color: #555;
      margin-top: 0;
    }
    .icon {
      font-size: 48px;
      margin-bottom: 8px;
    }
    .status {
      margin-top: 16px;
      padding: 12px 14px;
      border-radius: 12px;
      background: #f3f4f6;
      color: #111;
      font-size: 0.9rem;
      text-align: left;
    }
    .ok { background: #ecfdf5; color: #065f46; }
    .err { background: #fef2f2; color: #991b1b; }
    .spinner {
      width: 20px; height: 20px;
      border: 3px solid #e5e7eb;
      border-top-color: #111827;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-right: 8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hint {
      margin-top: 12px;
      font-size: .85rem;
      color: #6b7280;
    }
    .btn {
      display: inline-block;
      background: #004aad;
      color: #fff;
      padding: 12px 20px;
      margin-top: 20px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: background 0.3s;
    }
    .btn:hover {
      background: #003a87;
    }
    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 0.8rem;
      margin-top: 10px;
      color: #555;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="icon">üöö</div>
    <h1>Registro de Chegada</h1>
    <h2>LSL Transportes ‚Äì PAD Sim√µes Filho</h2>
    <p>Para registrar sua chegada, permita o acesso √† localiza√ß√£o e esteja no per√≠metro da empresa.</p>
    <button class="btn" onclick="init()">Iniciar Registro</button>
    <div id="status" class="status" style="display:none;"></div>
    <div id="debug" class="mono"></div>
  </div>

<script>
  // CONFIGURA√á√ïES
  const LAT_EMPRESA = -12.808930812471532;
  const LNG_EMPRESA = -38.42873008974748;
  const RAIO_METROS = 150;
  const LINK_FORM = "https://docs.google.com/forms/d/1HdaFhx9qkbRRAote0J4oY5-pHBOlYdxN_XniWPBzNn4/viewform";

  function distanciaEmMetros(lat1, lon1, lat2, lon2) {
    const R = 6371e3;
    const toRad = deg => deg * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2) ** 2 +
              Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
              Math.sin(dLon/2) ** 2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  function setStatus(html, cls="") {
    const box = document.getElementById("status");
    box.className = "status " + cls;
    box.style.display = "block";
    box.innerHTML = html;
  }

  function debug(msg) {
    const el = document.getElementById("debug");
    el.textContent = (el.textContent ? el.textContent + "\n" : "") + msg;
  }

  function handlePosition(pos) {
    const { latitude, longitude, accuracy } = pos.coords;
    const dist = Math.round(distanciaEmMetros(latitude, longitude, LAT_EMPRESA, LNG_EMPRESA));
    debug(`lat: ${latitude.toFixed(6)}, lng: ${longitude.toFixed(6)}, precis√£o: ${Math.round(accuracy)}m, dist: ${dist}m`);

    if (accuracy > 150) {
      setStatus(`<strong>Precis√£o fraca (${Math.round(accuracy)}m).</strong> Ative o GPS em alta precis√£o e tente novamente.`, "err");
      return;
    }

    if (dist <= RAIO_METROS) {
      setStatus(`<strong>Local verificado!</strong> Redirecionando para o formul√°rio‚Ä¶`, "ok");
      const url = new URL(LINK_FORM);
      url.searchParams.set("utm_lat", latitude.toFixed(6));
      url.searchParams.set("utm_lng", longitude.toFixed(6));
      url.searchParams.set("utm_acc", Math.round(accuracy));
      setTimeout(() => window.location.replace(url.toString()), 1200);
    } else {
      setStatus(`<strong>Fora do per√≠metro.</strong> Voc√™ est√° a ${dist}m do ponto autorizado.`, "err");
    }
  }

  function handleError(err) {
    let msg = "N√£o foi poss√≠vel obter sua localiza√ß√£o.";
    if (err.code === 1) msg = "Permiss√£o negada. Toque em 'Iniciar Registro' e permita o acesso.";
    if (err.code === 2) msg = "Posi√ß√£o indispon√≠vel. Verifique se o GPS est√° ligado.";
    if (err.code === 3) msg = "Tempo esgotado tentando obter a posi√ß√£o.";
    setStatus("<strong>" + msg + "</strong>", "err");
    debug("Erro (" + err.code + "): " + err.message);
  }

  function init() {
    if (!("geolocation" in navigator)) {
      setStatus("<strong>Seu dispositivo n√£o suporta geolocaliza√ß√£o.</strong>", "err");
      return;
    }
    setStatus("<span class='spinner'></span><strong>Buscando sua posi√ß√£o...</strong>");
    navigator.geolocation.getCurrentPosition(handlePosition, handleError, {
      enableHighAccuracy: true,
      timeout: 15000,
      maximumAge: 0
    });
  }
</script>
</body>
</html>
