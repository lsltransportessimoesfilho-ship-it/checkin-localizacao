<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Check-in Motoristas</title>
  <style>
    :root { color-scheme: light dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap { min-height: 100vh; display: grid; place-items: center; padding: 24px; }
    .card { width: 100%; max-width: 720px; border: 1px solid #ddd; border-radius: 16px; padding: 20px; box-shadow: 0 4px 16px rgba(0,0,0,.06); }
    h1 { font-size: 20px; margin: 0 0 12px; }
    #status { font-size: 14px; line-height: 1.5; margin-top: 10px; white-space: pre-line; }
    .btn { appearance: none; border: 0; border-radius: 12px; padding: 12px 16px; font-weight: 600; cursor: pointer; }
    .btn-primary { background: #111827; color: #fff; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    #formulario { display:none; position: fixed; inset: 0; background: #fff; }
    #formulario iframe { width: 100%; height: 100%; border: 0; }
    .loader { display:none; margin-top: 12px; font-size: 14px; }
    noscript { color: #b91c1c; font-weight: 600; }
  </style>
</head>
<body>
  <noscript>Este site precisa de JavaScript para funcionar.</noscript>

  <div class="wrap" id="telaInicial">
    <div class="card">
      <h1>Check-in de Motoristas</h1>
      <p>Toque no botão abaixo para iniciar o check-in com geolocalização.</p>

      <button id="btnIniciar" class="btn btn-primary">Iniciar check-in</button>
      <div id="status"></div>
      <div id="loading" class="loader">Carregando…</div>
    </div>
  </div>

  <!-- Contêiner em tela cheia para o formulário -->
  <div id="formulario">
    <iframe id="iframeForm" src="" title="Formulário de Check-in"></iframe>
  </div>

  <script>
    // Coordenadas de destino e raio permitido
    const LATITUDE_ALVO  = -12.6316685;
    const LONGITUDE_ALVO = -38.265392;
    const RAIO_MAX_METROS = 150;

    // Link EMBED correto do Google Forms (não abre nova aba)
    const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSc9tq-rajX4bXekfQcl8p01VraF5lRMPg0uJAnVBIx_KTzW5w/viewform?embedded=true";

    const statusEl   = document.getElementById('status');
    const loadingEl  = document.getElementById('loading');
    const btnIniciar = document.getElementById('btnIniciar');
    const formWrap   = document.getElementById('formulario');
    const iframeForm = document.getElementById('iframeForm');

    btnIniciar.addEventListener('click', iniciarRegistro);

    function iniciarRegistro() {
      statusEl.textContent = "Solicitando permissão de localização…";
      loadingEl.style.display = "block";
      btnIniciar.disabled = true;

      if (!('geolocation' in navigator)) {
        statusEl.textContent = "Geolocalização não é suportada neste navegador.";
        loadingEl.style.display = "none";
        btnIniciar.disabled = false;
        return;
      }

      // Solicita posição (precisão padrão é suficiente aqui)
      navigator.geolocation.getCurrentPosition(onPosOk, onPosErro, {
        enableHighAccuracy: false,
        timeout: 15000,
        maximumAge: 0
      });
    }

    function onPosOk(pos) {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const distancia = calcularDistancia(lat, lon, LATITUDE_ALVO, LONGITUDE_ALVO);

      statusEl.textContent =
        `Localização capturada:
Latitude: ${lat.toFixed(6)}
Longitude: ${lon.toFixed(6)}
Distância até o ponto-alvo: ${distancia.toFixed(1)} m`;

      if (distancia <= RAIO_MAX_METROS) {
        statusEl.textContent = "Dentro do perímetro. Abrindo formulário…";
        // Mostra iframe em tela cheia e carrega o formulário
        setTimeout(() => {
          iframeForm.src = FORM_URL;
          formWrap.style.display = "block";
          // Opcional: esconder a tela inicial por completo
          document.getElementById('telaInicial').style.display = "none";
        }, 800);
      } else {
        statusEl.textContent = `Você está fora do perímetro permitido (${RAIO_MAX_METROS} m). Aproximar-se do local para realizar o check-in.`;
        btnIniciar.disabled = false;
      }
      loadingEl.style.display = "none";
    }

    function onPosErro(err) {
      const mensagens = {
        1: "Permissão de localização negada. Autorize a localização e tente novamente.",
        2: "Posição indisponível. Verifique o GPS/internet.",
        3: "Tempo esgotado ao obter localização. Tente novamente."
      };
      statusEl.textContent = mensagens[err.code] || "Erro ao obter localização.";
      loadingEl.style.display = "none";
      btnIniciar.disabled = false;
    }

    // Haversine em metros
    function calcularDistancia(lat1, lo
